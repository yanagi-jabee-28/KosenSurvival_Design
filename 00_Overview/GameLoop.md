# Game Loop

ゲーム進行の基本サイクルと状態遷移を定義する。KOSEN Survivalは「週単位」「日単位（ズームイン時）」の2つの時間スケールで動作する。

---

## 1. Main Loop: 週ループと年ループ

### A. 年間スケジュール (Yearly Schedule)
**5年間（Year 1〜5）を4つのクォーターに分割。各年は32週で構成される。**

```
Year 1 ~ Year 5
  ├─ 1Q (Week 1-8) : 前期・前半 → Boss Event: 前期中間試験
  ├─ 2Q (Week 9-16) : 前期・後半 → Boss Event: 前期期末試験
  ├─ Summer Special : 夏休み（補習/合宿） → Optional Events
  ├─ 3Q (Week 17-24) : 後期・前半 → Boss Event: 後期中間試験
  ├─ 4Q (Week 25-32) : 後期・後半 → Boss Event: 学年末試験
  └─ Year End Sequence : 学年推移、ルート分岐判定、イベント処理
```

### B. 週ループ (Weekly Loop)

**各週は3つの進行モードから選択可能。月〜金曜の進行方法により異なる。**

#### Mode 1: 完全自動モード (Full Auto Mode)
プレイヤーの初期性格、現在のステータス、Motivation、Sanity値から、システムが方針を**自動決定**。5日間自動進行。

**【メリット】**:
- **時短効率 +50%**: 1週間を数秒で処理。プレイ時間を大幅削減
- **安定性**: 致命的ミス（入院、メンタル崩壊）が発生しにくい
- **隠しボーナス「オートパイロット達人」**: 連続10週Auto使用で Logic +5, Efficiency Trait 獲得
- **ストレスフリー**: 微細な管理不要。大局観に集中できる

**【デメリット】**:
- **イベント取りこぼし -30%**: ランダムイベント、レアアイテム、好感度上昇イベントを逃しやすい
- **最適化不足**: 手動より効率が15-20%劣る（特に試験前）
- **隠し要素発見不可**: 特定条件でのみ発生する「奇跡の出会い」系イベントは絶対に起きない
- **コンボ中断**: 連続行動ボーナス（後述）が蓄積されない

**【推奨使用状況】**:
- Year 1前半（基礎固め期間）
- 夏休み・冬休みの安定期
- 2周目以降のスピードラン
- 疲労困憊時の回復週

**判定アルゴリズム**:
```
[週初判定フェーズ]
  Input: Growth Type (エンジニア/リサーチャー/ハッカー/マネージャー/漂流者)
         + Vitality (現在値)
         + Sanity (現在値)
         + Motivation (現在値)
         + Karma (現在値)
         + 直近の失敗/成功経験
  
  Logic:
    if Sanity < 30:
      → 「心身の回復が優先」: [睡眠重視 / 交流推進 / 軽い活動]
    
    if Vitality < 40:
      → 「疲労困憊」: [休息・療養 / 二度寝 / 早寝]
    
    if テスト1週間前:
      → 「試験対策モード」: [勉強集中 / 授業真面目 / 図書館]
    
    if 直近で赤点 & Motivation < 50:
      → 「回復モード」: [好きなルート活動 / 交流 / 趣味]
    
    if Motivation > 70 & Sanity > 60 & Vitality > 60:
      → 「チャレンジモード」: [新しいアクション試行 / 自習集中]
    
    Growth Type別デフォルト:
      - エンジニア: [部活優先 / 実習 / 工作]
      - リサーチャー: [図書館 / 自習 / 研究]
      - ハッカー: [情報系実習 / 夜間活動]
      - マネージャー: [委員会 / 交流 / 調整]
      - 漂流者: [休息 / 趣味 / ルーチン]
  
  Output: 週の方針 (Policy) 自動決定 → 実行
```

**処理内容**:
- 5日分の自動パラメータ変動（Vitality, Sanity, 科目実力など）
- ランダムイベント判定（友人イベント、アイテム獲得など） **※発生率 -30%**
- 自動決定された行動記録は「日誌」として記録される
- **「安全運転ボーナス」**: Vitality/Sanityが閾値を下回らない限り、パラメータの下限を30で保証
- **効率ペナルティ**: 学習効率 -15%, 好感度上昇 -20%
- **Auto連続回数カウント**: 10週連続で特殊Trait解放

---

#### Mode 2: AI提案モード (AI Suggested Mode)
システムが「今週のおすすめプラン」を3〜5個提案。プレイヤーが選択・調整可能。**バランス型の中核モード**。

**【メリット】**:
- **学習AI**: プレイヤーの過去の選択を分析し、週を重ねるごとに提案精度が向上
- **リスク可視化**: 各プランの「成功率」「リスクレベル」「期待値」が数値表示される
- **微調整可能**: AIの提案をベースに、3つの要素を個別調整できる柔軟性
- **「AI協調ボーナス」**: 提案を5週連続採用で Charisma +3, 次週の提案品質 +20%
- **時短とリターンの両立**: Autoより効率+15%, Manualより時短+60%

**【デメリット】**:
- **選択肢の制約**: AIが提示した3〜5案からしか選べない（完全自由度はない）
- **学習期間必要**: Year 1最初の4週間は提案精度が低い（ランダム性高）
- **極端な戦略不可**: ハイリスク・ハイリターン型の賭けがしにくい
- **依存リスク**: AI提案に頼りすぎると、Manual操作時の判断力が低下（隠しデバフ）

**【推奨使用状況】**:
- Year 1後半〜Year 3（ルート構築期）
- 通常週（イベントなし、テスト前ではない）
- 初心者プレイヤー
- 方針は決まっているが細かい管理は任せたい時

**週初提案フェーズ**:
```
Monday Morning - デイリープランニング画面

┌─────────────────────────────────┐
│  今週の気分は？ (Current Mood)  │
├─────────────────────────────────┤
│ Vitality: ███░░ 65/100          │
│ Sanity:   ░░░░░ 28/100 ⚠️       │
│ Motivation: ██░░░ 45/100        │
├─────────────────────────────────┤
│ 【システムの提案】              │
│                                 │
│ 🟢 案1: 「メンタルリセット」    │
│    放課後交流優先、早寝推奨。   │
│    Sanity 回復が最優先です。   │
│                                 │
│ 🟡 案2: 「バランス型」          │
│    いつも通りの生活リズム。     │
│    負担の少ない活動を。         │
│                                 │
│ 🔵 案3: 「やり込みプラン」      │
│    テストが近いため学習推進。   │
│    部活は3日に留めます。        │
│                                 │
│ 🟣 案4: 「マイペース」          │
│    昨週と同じ方針で続行。       │
│                                 │
│ ⚫ 案5: 「カスタム作成」         │
│    自分で細かく設定する。       │
├─────────────────────────────────┤
│ [案を選択] → [微調整] → [決定]│
└─────────────────────────────────┘
```

**微調整パネル**:
```
選択後、以下の3つを個別に調整可能：

  授業態度: [真面目 / 内職 / 睡眠]
  放課後: [部活 / 直帰 / 図書館]
  夜: [予習 / 趣味 / 寝る]
```

**処理内容**:
- 提案プランを承認または微調整して実行
- 5日分の自動パラメータ変動（微調整内容を反映）
- プレイヤーの「調整履歴」を学習し、以降の提案に反映（学習精度: 週数 × 2%、上限 50%）
- **「AI信頼度」パラメータ**: 提案採用率に応じて上昇。高いほど提案の質が向上
- **ランダムイベント発生率**: 標準（±0%）
- **微調整ボーナス**: 提案を採用後に微調整した場合、調整部分の効率 +10%

---

#### Mode 3: 完全マニュアルモード (Full Manual Mode)
毎日各時間帯（7段階）を**個別に手動選択**。完全な制御を実現。**上級者向け・最大効率追求モード**。

**【メリット】**:
- **最大効率 +30%**: 全モード中、最もパラメータ上昇効率が高い
- **コンボシステム解放**: 特定の行動を連続させると「コンボボーナス」発生（後述）
- **レアイベント確率 +50%**: 手動操作でのみ発生する隠しイベント多数
- **完全制御**: 1時間単位での最適化。リソースを1も無駄にしない
- **「職人の勘」発動**: 10回以上の手動週で、次の選択肢の効果予測が表示される
- **ミニゲーム解放**: 授業中の内職、闇工作などでミニゲーム発生 → 成功で効果 2倍

**【デメリット】**:
- **プレイ時間 5〜10倍**: 1週間に10〜15分かかる（Autoは10秒）
- **ミスのリスク大**: 判断ミスで致命的な状況（入院、赤点）に陥りやすい
- **疲労蓄積**: 連続3週間Manualを使うと、プレイヤー自身の集中力低下（現実の疲労）
- **見落としリスク**: 週全体の流れを見失い、リソース枯渇や締切忘れが発生

**【推奨使用状況】**:
- テスト1〜2週間前（追い込み）
- 重要イベント週（ヒロイン告白、ルート分岐など）
- Year 4〜5（GPA戦争、卒研）
- 2周目以降の完璧主義プレイ
- ハイリスク・ハイリターンな賭けに出る時

**平日マニュアルペイン**:
```
Monday (AM Class の例)

┌─────────────────────────────────┐
│ Monday - AM Class               │
│ 時刻: 09:30〜11:50             │
├─────────────────────────────────┤
│                                 │
│ 【今の気分は？】                │
│   🟢 やる気がある               │
│   🟡 普通                       │
│   🔴 やる気がない               │
│   💤 眠い                       │
│                                 │
│ 【授業対象 (本日)】             │
│ - 数学I (理解度: 42/100)       │
│ - 物理I (理解度: 55/100)       │
│ - 国語 (理解度: 38/100)        │
│                                 │
│ 【選択肢】                      │
│ [1] 真面目に受ける              │
│     → 理解度+8-12, Vitality-5  │
│     → ランダムイベント低確率   │
│                                 │
│ [2] 内職する (特定科目)        │
│     → 選択科目の実力+5-10      │
│     → Sanity-3, 先生に見つかる│
│        確率 20%                │
│                                 │
│ [3] 寝る                        │
│     → Vitality+15, Sanity+5    │
│     → 理解度-5, Karma+2        │
│     → 怒られるリスク 40%       │
│                                 │
│ [4] 欠席する                    │
│     → Vitality-8 (気分悪化)    │
│     → 出席日数-1, Karma+5      │
│     → イベント: 保健室へ       │
│                                 │
│ 【現在のリソース】              │
│ Vitality: 42/100  Sanity: 28/100
│ Time: 5/7 段階残存             │
│                                 │
│ [実行] [キャンセル]            │
└─────────────────────────────────┘
```

**全7時間帯 (Manual Only)**:
```
Morning (朝)
  └─ [登校 / 二度寝 / 遠征]
     各選択肢で Vitality / Sanity / Time 変動

AM Class (午前授業)
  └─ [真面目 / 内職 / 寝る / 欠席]
     科目選択可。理解度・実力の増減

Lunch (昼食)
  └─ [昼食 / 昼寝 / 交流]
     Vitality 回復 / 好感度変動 / イベント

PM Class (午後授業)
  └─ [真面目 / 内職 / 寝る / サボる]
     科目選択可

After School (放課後)
  └─ [部活 / アルバイト / イベント / 勉強]
     スキル上昇 / Money変動 / 好感度

Night (夜)
  └─ [勉強 / 趣味 / 闇工作 / 交流]
     科目実力 / Motivation / Karma 変動

Sleep (就寝)
  └─ [通常睡眠 / 徹夜 / 爆睡]
     Sanity / Burn Out Level / 次日Vitality
```

---

#### Mode切り替え・土日・イベント日の動作

**モード選択タイミング**:
- 各週のMonday Morning (週初フェーズ) に3モード選択
- **週途中での変更は原則不可** → 計画性が重要
- 緊急時のみ「モード切替クエスト」発動可能:
  - コスト: Vitality -20, Sanity -10, Money -3000
  - 効果: 残りの日数をManual Modeで操作可能
  - 制約: 1つのクォーター（8週）につき1回まで

**モード切替ペナルティ（頻繁に変えすぎた場合）**:
- 連続3週間異なるモードを使用 → 「計画性欠如」デバフ
  - Motivation -10, 学習効率 -15% (2週間持続)
- 逆に、同じモードを8週連続 → 「習熟ボーナス」
  - そのモードの効率 +10%, 固有Trait解放

**土日とイベント日**:
- 全モード共通で **Semi-Manual Mode** に切り替わり
  - 重要な選択肢のみ手動（3〜5回の選択）
  - 細かい時間管理は自動化
- **「週末ボーナスタイム」**: 土日は特別なイベント、レアアイテム、好感度2倍イベントが高確率で発生
- **リスク選択肢の出現**: 「賭け」要素のある選択肢が登場
  - 例: 「徹夜で勉強」→ 成功で実力+50、失敗で入院
  - 例: 「ヒロインを誘う」→ 成功で好感度+15、失敗で -10
- **Auto継続オプション**: Full Auto使用中の場合、土日もAutoで進行可能
  - ただし、週末限定イベントを100%取りこぼす

**テスト期間 (1週間前～本番日)**:
- 全モード → **テスト対策モード (Exam Mode)** への強制切り替え
- 「追試対策」「集中学習」などのボーナスアクション解放

---

## 2. Player Actions: 可能なコマンドとコンボシステム

### コンボシステム (Combo Bonus System)
**特定の行動を連続・組み合わせると、追加効果が発生する。Manual Mode専用。**

#### A. 連鎖コンボ (Chain Combo)
同じカテゴリのアクションを連続実行すると、効果が累積増加。

| 連鎖回数 | ボーナス | 発動条件 | リスク |
|:---|:---|:---|:---|
| **2連鎖** | 効果 +20% | 同カテゴリを連続2回 | なし |
| **3連鎖** | 効果 +50% | 同カテゴリを連続3回 | Vitality追加消費 -5 |
| **4連鎖** | 効果 +100%, 特殊Trait獲得 | 同カテゴリを連続4回 | Sanity -10, Burn Out +15 |
| **5連鎖** | 効果 +200%, レア報酬 | 同カテゴリを連続5回 | Vitality/Sanity 大幅減少、過労リスク |

**例**: 
- 「自習 → 図書館 → 自習 → 論文読破」= 学習4連鎖 → 最後の実力上昇が通常の3倍

#### B. シナジーコンボ (Synergy Combo)
異なるカテゴリを組み合わせて特殊効果を発動。

| コンボ名 | 行動組み合わせ | 効果 | 解放条件 |
|:---|:---|:---|:---|
| **理論と実践** | 午前: 授業真面目 → 午後: 部活 | 科目実力 +30%, スキル +20% | 常時 |
| **夜の猛勉強** | 夜: 勉強 → 睡眠: 徹夜 | 実力 +80, 翌日Vitality -40 | Logic > 10 |
| **社交の達人** | 昼食: 交流 → 放課後: イベント | 好感度 2倍, Charisma +2 | Charisma > 5 |
| **闇のサイクル** | 夜: 闇工作 → 睡眠: 通常 → 朝: 遠征 | Money +15000, Karma +8 | Route C |
| **完璧主義者** | 全時間帯を学習系で埋める | 実力 +150, Logic +5, Sanity -30, 隠し実績 | Year 2以降 |
| **リフレッシュ** | 昼寝 → 放課後直帰 → 趣味 → 爆睡 | Vitality/Sanity 完全回復, Motivation +20 | Sanity < 40 |

#### C. 時間帯ボーナス (Timing Bonus)
特定の時間帯に特定の行動を取ると効果増幅。

| 時間帯 | 推奨行動 | ボーナス |
|:---|:---|:---|
| **Morning (朝)** | 早起き登校 | Vitality回復 +5, Motivation +3 |
| **AM Class** | 数学・物理の授業を真面目に | 理解度 +30% |
| **Lunch** | 交流イベント | 好感度上昇 1.5倍 |
| **PM Class** | 内職（専門科目） | 実力上昇 +40% |
| **After School** | 部活動 | スキル上昇 +50% (ゴールデンタイム) |
| **Night** | 自習 | 実力上昇 +20%, 静かな環境ボーナス |
| **Sleep** | 23時前に就寝 | Sanity +15, 翌日Motivation +10 |

---

### A. 学習系アクション（バランス調整版）

| アクション | 効果 | コスト | 成功率 | リスク/リターン | 解放条件 |
|:---|:---|:---|:---|:---|:---|
| **授業聴講** | 理解度 +5〜15 | Vitality -5 | 95% | 低リスク・低リターン | 常時 |
| **自習** | 実力 +10〜20 | Vitality -10, Time -1 | 90% | 中リスク・中リターン | 常時 |
| **図書館** | 知識 +5, Logic +1, 理解度 +3 | Vitality -8, Time -1 | 95% | 低リスク・成長型 | 常時 |
| **追試対策** | 特定科目実力 +20〜35 | Vitality -15, Sanity -10, Time -3 | 85% | 高リスク・高リターン | 赤点発生後 |
| **論文読破** | 理解度 +30, Logic +3 | Vitality -15, Sanity -8, Time -3 | 70% | 高リスク・専門特化 | Logic Lv.20以上 |
| **グループ学習** | 実力 +15, 好感度 +3 (参加者) | Vitality -12, Time -2 | 80% | 中リスク・社交併用 | 友人3人以上 |
| **教授質問** | 理解度 +25, 実力 +10, 教授好感度 +5 | Vitality -8, Time -1 | 75% | 低リスク・長期投資 | Year 2以降 |

**失敗時のペナルティ**:
- 授業聴講失敗 → 寝落ち、理解度 -3, Karma +1
- 自習失敗 → 集中力欠如、実力 +5のみ (半減)
- 追試対策失敗 → Sanity -20, 次週に追試再受験必須

---

### B. 活動系アクション（バランス調整版）

| アクション | 効果 | コスト | 成功率 | リスク/リターン | 解放条件 |
|:---|:---|:---|:---|:---|:---|
| **部活動** | スキル +5〜10, 好感度 +2 | Vitality -10, Time -1 | 95% | 低リスク・ルート直結 | 部活加入 |
| **委員会** | Charisma +1, ランダムイベント | Vitality -8, Time -1 | 90% | 低リスク・人脈形成 | 委員会加入 |
| **アルバイト** | Money +2000〜5000 | Vitality -12, Sanity -5, Time -2 | 100% | 中リスク・金策 | Year 2以降 |
| **深夜バイト** | Money +8000〜12000 | Vitality -25, Sanity -15, Time -3, Karma +3 | 100% | 高リスク・大金 | Year 3以降, Karma > 15 |
| **イベント回収** | キャラ好感度 +5, アイテム獲得 60% | Vitality -5, Time -1 | 100% | 低リスク・必須活動 | 発生時のみ |
| **ボランティア** | Karma -5, 実績値 +10, Charisma +2 | Vitality -10, Time -2 | 100% | 中リスク・浄化手段 | Year 3以降 |
| **大会参加** | ルートポイント +30, 実績解放 | Vitality -30, Sanity -20, 1週間準備 | 60-80% | 超高リスク・勝負 | ルート専用 |

---

### C. 社交系アクション（バランス調整版）

| アクション | 効果 | コスト | 成功率 | リスク/リターン | 解放条件 |
|:---|:---|:---|:---|:---|:---|
| **キャラクター交流** | 好感度 +3, ランダムイベント | Vitality -3, Time -1 | 95% | 低リスク・関係構築 | 好感度 > 10 |
| **食事共有** | 複数キャラ好感度 +2, Sanity +10 | Vitality -8, Money -500, Time -1 | 100% | 低リスク・回復兼用 | 学食/カフェ解放 |
| **恋愛イベント** | ヒロイン好感度 +5, ルートポイント +10 | Vitality -5, Time -2 | 85% | 中リスク・ルート重要 | 親密度 > 20 |
| **告白** | 関係確定, ルートボーナス | Vitality -15, Sanity -25 | 50-90% | 超高リスク・一世一代 | 親密度 > 50, Year 3以降 |
| **デート** | 好感度 +8, Sanity +15, CG解放 | Vitality -10, Money -3000, Time -3 | 80% | 中リスク・高揚感 | 恋人関係 |
| **相談に乗る** | 好感度 +5, Trust +10, 情報獲得 | Vitality -8, Sanity -5, Time -2 | 90% | 低リスク・絆深化 | 好感度 > 30 |

**告白の成功率計算**:
```
基礎成功率 = 50%
+ (好感度 - 50) × 1%
+ Trust Level × 2%
+ Charisma × 1%
- (相手のプライド値) × 0.5%
= 最終成功率 (上限 95%, 下限 10%)
```

---

### D. 闇系アクション (Route C専用, バランス調整版)

| アクション | 効果 | コスト | 成功率 | リスク/リターン | 解放条件 |
|:---|:---|:---|:---|:---|:---|
| **ハッキング** | Money +10000, 情報獲得, Karma +10 | Vitality -8, Sanity -15, Time -2 | 60-80% | 超高リスク・大金 | Karma > 20, 情報実力 > 60 |
| **取引 (闇市)** | 特定アイテム獲得, Karma +5 | Vitality -5, Money 変動, Time -1 | 90% | 中リスク・必需品入手 | タケシ好感度 > 15 |
| **不正サービス提供** | Money +5000, Karma +5, 人脈 | Vitality -10, Sanity -10 | 95% | 中リスク・定期収入 | 進行度による |
| **データ盗難** | 試験問題入手, Karma +15 | Vitality -12, Sanity -20, Time -2 | 40% | 超高リスク・チート | Year 2以降, Karma > 30 |
| **裏口工作** | GPA +0.5, Karma +20 | Money -50000, Sanity -30 | 70% | 禁断・破滅的 | Year 4以降, 諏訪野ルート |

**ハッキング失敗時**:
- 50%: 小規模バレ → Karma +20, 教授に呼び出し
- 30%: 中規模バレ → 停学1週間, Karma +40
- 20%: 大規模バレ → 退学危機イベント, Route C強制確定

---

### E. 緊急系・システムアクション（バランス調整版）

| アクション | 効果 | コスト | 成功率 | リスク/リターン | 解放条件 |
|:---|:---|:---|:---|:---|:---|
| **保健室へ** | Vitality +30 | Time -2, イベント消費 | 100% | 低リスク・回復手段 | Vitality < 30 |
| **カウンセリング** | Sanity +50, Burn Out -30 | Time -2, Money -1000 | 100% | 低リスク・精神ケア | Sanity < 20 |
| **寝坊** | Vitality +40, 授業欠席 | 出席日数 -1, イベント発生 | 自動 | 中リスク・遅刻常習化 | 自由 |
| **仮病** | Vitality +20, 授業/活動スキップ | Karma +3, Trust -5 (発覚時) | 70% | 中リスク・ズル | 自由 |
| **カンニング** | テスト点 +20 | Karma +15, 発覚率 30% | 30-70% | 超高リスク・破滅的 | テスト時のみ |
| **SKIP (タイムスキップ)** | 1週間進行、自動判定 | 主要イベント100%損失 | 100% | 非推奨・時間売却 | 自由 |

**仮病発覚時**:
- 教師 Trust -10
- クラスメイト好感度 -5 (全員)
- 次週から仮病成功率 -20%

---

## 3. State Transitions: 状態遷移と判定

### A. 時間進行時の状態判定フロー

```mermaid
[時間経過 1時間帯進行]
    ↓
[パラメータ自動変動]
    ├─ Vitality 減少 (アクション種別による)
    ├─ Sanity 減少 (ストレス蓄積)
    ├─ 科目実力/理解度 増加 (学習選択時)
    └─ Good/Bad Event 判定 (ランダム)
    ↓
[ピンチ条件チェック]
    ├─ Vitality <= 0 ? → 入院イベント (1週間スキップ)
    ├─ Sanity <= 0 ? → メンタル崩壊イベント (Sanity回復クエスト)
    └─ Karma > 80 ? → 風紀委員召喚イベント
    ↓
[日内処理完了]
```

### B. 週単位の状態判定

```
[週終了時点]
    ↓
[テスト期間判定]
    ├─ YES → テストイベント発生 (全科目実力判定)
    │   ├─ 成功 (実力+理解度 > 合格ライン)
    │   └─ 失敗 → 赤点フラグ発生
    └─ NO → 通常進行
    ↓
[ルートフラグ判定]
    ├─ Engineering Points 集計
    ├─ Academic Points 集計
    ├─ Underground Points 集計
    ├─ Management Points 集計
    └─ Drifter Points 集計
    ↓
[年度末判定 (Week 32)]
    ├─ 全フラグ < 閾値 → Route E へ自動分岐
    ├─ 複数フラグ > 閾値 → プレイヤー選択分岐
    └─ 単一フラグ MAX → ルート確定
    ↓
[年度推移]
```

### C. ルート分岐の厳密な流れ (Year 3での確定)

**Year 3 Week 32 終了時**:

```
[各ルートのポイント集計]
    ↓
[ルート別の確定条件チェック]
    ├─ Route A: Engineering > 100 & ミナ好感度 > 40
    ├─ Route B: Academic > 100 & アイ好感度 > 40 & Logic > Lv.20
    ├─ Route C: Underground > 100 & Karma > 40
    ├─ Route D: Management > 100 & Charisma > Lv.10
    └─ Route E: 上記いずれも不満たす
    ↓
[分岐イベント発生]
    ├─ Route A → ミナから勧誘イベント
    ├─ Route B → アイから研究パートナー打診
    ├─ Route C → タケシから正式な誘い
    ├─ Route D → マイから学生会副会長就任打診
    └─ Route E → 室井禅からの「特別講話」
    ↓
[プレイヤー選択] OR [自動確定]
    ↓
[Year 3 Opening: ルート固定]
```

### D. 月単位のボスイベント (Boss Event Flow)

**テスト期間 (Week 8, 16, 24, 32)**:

```
[テスト前フェーズ]
    ├─ 警告ダイアログ: 「〇日後にテストです」
    ├─ 特別アクション解放: 「追試対策」「集中講義」
    └─ マイナスイベント増加 (寝坊、病気など)
    ↓
[テスト実施フェーズ]
    ├─ 全5科目の判定
    │  └─ 実力値 vs 合格ライン (80)
    ├─ 成功 → 科目実力+20, 好感度+3 (当番講師)
    └─ 失敗 → 赤点フラグ, 追試権獲得
    ↓
[テスト後フェーズ]
    ├─ 成績掲示 (GPA計算)
    ├─ 教授面談イベント (Year 4+)
    └─ 赤点回避者の優越感イベント (Year 1-2)
```

### E. 年度推移時の状態リセット

**Year 終了 → 次Year開始時**:

```
[Year End Sequence]
    ├─ ルート分岐判定 (Year 3でのみ)
    ├─ キャラロケーション更新 (進級による配置変更)
    ├─ 科目更新 (Year 2で系選択による科目変更)
    ├─ 学生寮アップグレード (Year 3で個室へ)
    ├─ パラメータの部分リセット
    │  ├─ Vitality → 50
    │  ├─ Sanity → 70
    │  ├─ Burn Out → 0
    │  └─ 科目実力 → 70% 유지 + 新科目は初期値
    └─ 新Year Opening Cutscene
```

---

## 4. イベントは計画的に — 決定的イベント設計

プレイヤーの要望に応じ、**ランダム性を極力排した決定論的イベントシステム**を導入します。ここでは「イベントの型（テンプレート）」「発生条件（トリガ）」「実行ウィンドウ」「分岐・結果」までを体系的に定義し、すべて実装可能なパターンとして記述します。フレーバー表現のわずかな変化のみが状態に依存して変わる程度で、発生有無や結果は基本的に確定的です。

---

### A. イベント分類（包括）

- Scheduled（予定イベント）: カレンダーに固定されるイベント（例: 中間/期末試験、合宿、文化祭、大会）
- Triggered（条件発生イベント）: プレイヤーの状態やフラグが閾値を満たしたときに発生（例: 好感度・Karma・赤点など）
- Chained（連鎖イベント）: 累積された行動によって直列的に発生するイベント群（例: 借金増→取り立て→闇仕事）
- Player-Initiated（能動イベント）: プレイヤーが明示的に起動するイベント（例: 大会参加申請、告白申請、闇取引セットアップ）
- Opportunity（条件的機会）: 一定条件を満たすと必ず現れる好機（例: Manual探索でのみ出る“発見”）
- Crisis（危機イベント）: しきい値超過で即発生する重大イベント（例: 入院、退学警告、過労休養）

---

### B. イベントテンプレート（主要パターンとバリエーション）

すべてのイベントはテンプレート化され、パラメータでバリエーションを作ります。ここでは主要テンプレートとそのバリエーションを網羅的に列挙します。

テンプレート共通項目:
- id, name, template_type, trigger_conditions, window, choices[], outcomes (deterministic mapping), priority, cooldown, visibility, mode_requirement

1) Friend Interaction（友人交流）
   - variants: casual_chat / help_request / challenge / group_event / date_invite
   - trigger: 好感度閾値、共通スケジュール（放課後等）
   - window: 放課後/昼/休日
   - outcome: 好感度+/-, 情報取得, 追随フラグ

2) Item Discovery（発見）
   - variants: common_material / rare_part / research_paper / lost_item
   - trigger: 探索アクション実行（Manual優遇） / 特定地点到達
   - window: 探索時間帯
   - outcome: アイテム付与、ミニクエスト開始

3) Bad Event（バッドイベント）
   - variants: illness / sleep_deprivation / theft / data_loss / family_issue
   - trigger: Sanity/Vitality閾値、Time枯渇、外部フラグ
   - window: 即時
   - outcome: Vitality/Sanity低下、時間損失、Trust低下

4) Bonus Event（成長機会）
   - variants: tutor_offer / scholarship / internship / recommendation
   - trigger: 成績/好感度/実績の閾値達成
   - window: 指定週
   - outcome: 実力/Logic/Charisma/Moneyの確定増加

5) Emergency Call（緊急）
   - variants: professor_call / parent_call / club_crisis / scandal_notice
   - trigger: 役職保持、Karma/成績閾値、連鎖条件
   - window: 即時（割り込み処理）
   - outcome: 選択による確定的報酬/罰則、スケジュール変更

6) Route Recruitment（ルート勧誘）
   - variants: RouteA_invite / RouteB_invite / RouteC_offer / RouteD_offer
   - trigger: 各ルートポイント閾値、特定Week
   - window: Year3確定フェーズ等
   - outcome: プレイヤー選択に基づくルート確定・分岐

7) Exam / Boss Event（試験・ボス）
   - variants: midterm / final / contest / presentation
   - trigger: カレンダー固定
   - window: 該当週の指定日
   - outcome: 成績判定（実力+理解度 vs 合格ライン）→ 追試/報酬

8) Opportunity Special（決定的“奇跡”）
   - variants: hidden_meeting / research_breakthrough / startup_pitch
   - trigger: 複合条件（好感度・実力・タイミング）満足で必ず発生
   - window: 狭い時間枠（週末・夜など）
   - outcome: 隠しフラグ付与、特殊報酬、CG/EDに影響

9) Chain Reaction（連鎖）
   - variants: debt_escalation / popularity_boom / burnout_sequence
   - trigger: 累積条件（例: Money<0 for N weeks）
   - window: 条件達成時に順次発生
   - outcome: 一連のイベント列→最終分岐

---

### C. イベントスケジューリングと実行（決定論的フロー）

1. 週初（Monday Morning）で **イベント候補リストを確定**:
   - scheduled ← calendar.fetch(week)
   - triggered ← evaluate_triggers(player_state, flags)
   - chained ← evaluate_chains(player_history)
   - opportunities ← evaluate_opportunities(player_state, mode)

2. 候補を priority（高→低）でソートし、ウィンドウに割当て（衝突解決は deterministic）
3. visible イベントのみプレイヤーへ通知（Manualモードでは hidden→visible になるイベントを許容）
4. プレイヤー選択により outcomes を deterministic に適用
5. 実行後、cooldown と次トリガへの影響を登録。ログに発生理由を記録し再現可能性を担保

---

### D. 実装スキーマ（例）

イベント定義は JSON/YAML で管理。例:
```
{ "id":"exam_mid_08", "template_type":"scheduled", "trigger_conditions": { "week": 8 }, "window": {"day": 4}, "choices": [...], "outcomes": {...}, "priority":90 }
```

---

### E. バリエーション方針（ランダム性を最小化しつつ表現を豊かに）

- 発生・結果は基本決定論。表現（セリフの語彙や小演出）は StateHash を用いて deterministic に変化させ、"見た目の多様性"を確保する。
- すべてのテンプレートに対してユニットテストを用意し、全トリガーパスを検証可能にする。
- Manual モードは "機会の幅" を広げる（発見や隠しイベントが visible になりやすい）が、起きるかどうかは条件次第で決まる。

---

この設計により「全てが計画されたもの」という要望に応えつつ、イベントの表現は豊かに保ち、検証性とデバッグ性を高く維持します。
## 5. リソース管理メカニクス（戦略的バランス版）

### A. リソース種別と回復源（詳細版）

| リソース | 上限 | 自然回復 | 回復源（効率順） | 消費源 | 危機閾値 |
|:---|:---|:---|:---|:---|:---|
| **Vitality** | 100 | +5/日 (睡眠時) | 爆睡(+40) > 保健室(+30) > 通常睡眠(+20) > 食事(+10) | 全アクション (-5〜-30) | < 30: 効率-20% |
| **Sanity** | 100 | +3/週 (安定時) | カウンセリング(+50) > 交流(+15) > 趣味(+10) > 睡眠(+5) | 試験(-20), 闇工作(-15), 失敗(-10) | < 20: コマンド拒否 |
| **Money** | 無制限 | 仕送り +30000/月 | 深夜バイト(+12000) > 闇取引(+10000) > 通常バイト(+5000) | アイテム, 交流, 緊急支出 | < 0: 借金イベント |
| **Time** | 7/日 | 毎朝リセット | - (回復不可) | 各アクション (-1〜-3) | < 2: 行動制限 |
| **Motivation** | 100 | -2/週 (自然減) | 成功体験(+20) > 好感度UP(+10) > 目標達成(+30) | 失敗(-15), 孤立(-10), 赤点(-20) | < 30: 効率-30% |
| **Burn Out** | 100 | -5/週 (安定時) | 完全休養(-40) > 趣味(-15) > 交流(-10) | 過労(+20), 徹夜(+30), 連続勉強(+15) | > 80: 崩壊リスク |

---

### B. リソース相互作用（トレードオフシステム）

**リソースは独立せず、相互に影響を与え合う。**

| トリガー | 効果 | 発動条件 | 持続時間 |
|:---|:---|:---|:---|
| **健全な精神は健全な肉体に** | Vitality > 70の時, Sanity自然回復 +3/週 | 常時 | - |
| **疲労困憊** | Vitality < 30の時, Sanity -5/日 | 常時 | Vitality回復まで |
| **金欠ストレス** | Money < 5000の時, Sanity -10/週 | 常時 | Money回復まで |
| **燃え尽き症候群** | Burn Out > 70, Motivation -20 | Burn Out高値 | 2週間 |
| **やる気MAXモード** | Motivation > 80, 全効率 +20% | 常時 | Motivation低下まで |
| **絶望の淵** | Sanity < 20 & Motivation < 30, 全パラメータ -30% | 複合条件 | 回復まで |
| **金持ちの余裕** | Money > 100000, Sanity +5/週, Charisma +1 | 常時 | Money減少まで |

---

### C. リソース不足時の段階的ペナルティ

#### Vitality段階別ペナルティ
```
100-70: 通常状態
69-50:  軽度疲労 → 効率 -10%, バッドイベント +5%
49-30:  中度疲労 → 効率 -20%, バッドイベント +15%, Sanity -3/日
29-10:  重度疲労 → 効率 -40%, 行動選択肢制限, 強制休養推奨
9-1:    瀕死 → 全行動不可, 次アクションで入院確定
0:      入院 → 1週間強制スキップ
```

#### Sanity段階別ペナルティ
```
100-70: 通常状態
69-50:  軽度不安 → Motivation -5, 社交系効率 -15%
49-30:  中度不安 → コマンド拒否(5%), 学習効率 -25%
29-10:  重度不安 → コマンド拒否(30%), 全効率 -50%, 孤立化
9-1:    限界 → コマンド拒否(80%), Vitality -10/日
0:      崩壊 → メンタルクエスト強制発生
```

#### Motivation段階別ペナルティ
```
100-70: 絶好調 → 効率 +10%
69-50:  通常
49-30:  低迷 → 効率 -20%, 自習系アクション拒否(20%)
29-10:  無気力 → 効率 -50%, 全行動に抵抗感
9-1:    虚無 → Route E確定リスク, 室井イベント
0:      廃人 → 自動退学 or Route E強制確定
```

---

### D. リソース最適化戦略（プレイヤーガイド）

**各Year別の推奨リソース配分**:

| Year | Vitality目標 | Sanity目標 | Money目標 | 優先リソース | 理由 |
|:---|:---|:---|:---|:---|:---|
| **Year 1** | 60以上 | 50以上 | 50000 | Vitality > Sanity | 基礎体力づくり, 赤点回避 |
| **Year 2** | 50以上 | 60以上 | 80000 | Sanity > Vitality | ルート構築, 人間関係 |
| **Year 3** | 60以上 | 70以上 | 100000 | バランス | ルート確定, 後輩指導 |
| **Year 4** | 40以上 | 50以上 | 150000 | Money > 他 | インターン, 就活費用 |
| **Year 5** | 30以上 | 40以上 | 任意 | Burn Out管理 | 卒研地獄, ラストスパート |

---

## 6. Ending Flowchart

**Year 5 Week 32 終了時**:

```
[ルート別の最終評価]
    ├─ Route A: ロボコン大会成績 + ミナ関係
    ├─ Route B: 卒研評価 + アイ関係
    ├─ Route C: Money総額 + Karma評価
    ├─ Route D: 学生会実績 + マイ関係
    └─ Route E: Motivation最終値
    ↓
[True / Normal / Bad の振り分け]
    ├─ True: 最高条件達成 (CG +エピローグ)
    ├─ Normal: 中程度条件達成 (スタンダードED)
    └─ Bad: 条件不達成 (バッドED)
    ↓
[エンディング個別ムービー再生]
    ├─ ルート固有ムービー (1分30秒程度)
    ├─ キャラ別エンディング (30秒)
    └─ スタッフロール
    ↓
[NEW GAME+ アンロック]
```

---

## 補足: デバッグ用コマンド

開発/テスト用に以下のコマンドを用意。

| コマンド | 効果 |
|:---|:---|
| **skip_week** | 1週間スキップ (状態判定は実行) |
| **set_param X Y** | パラメータを直接設定 (例: set_param Logic 30) |
| **trigger_event X** | 指定イベント発生 (例: trigger_event test_exam) |
| **change_route X** | ルート強制変更 (Year 3以降のみ) |
