# Game Loop

ゲーム進行の基本サイクルと状態遷移を定義する。KOSEN Survivalは「週単位」「日単位（ズームイン時）」の2つの時間スケールで動作する。

---

## 1. Main Loop: 週ループと年ループ

### A. 年間スケジュール (Yearly Schedule)
**5年間（Year 1〜5）を4つのクォーターに分割。各年は32週で構成される。**

```
Year 1 ~ Year 5
  ├─ 1Q (Week 1-8) : 前期・前半 → Boss Event: 前期中間試験
  ├─ 2Q (Week 9-16) : 前期・後半 → Boss Event: 前期期末試験
  ├─ Summer Special : 夏休み（補習/合宿） → Optional Events
  ├─ 3Q (Week 17-24) : 後期・前半 → Boss Event: 後期中間試験
  ├─ 4Q (Week 25-32) : 後期・後半 → Boss Event: 学年末試験
  └─ Year End Sequence : 学年推移、ルート分岐判定、イベント処理
```

### B. 週ループ (Weekly Loop)

**各週は2つのモードで進行する。**

#### Mode 1: オートパイロット (Weekday Auto Mode)
月〜金曜は**方針 (Policy)** に従って自動進行。プレイヤーは毎日コマンド入力不要。

**週初設定フェーズ**:
```
Monday Morning
  ├─ 授業態度: [真面目 / 内職 / 睡眠]
  ├─ 放課後: [部活 / 直帰 / 図書館]
  └─ 夜: [予習 / 趣味 / 寝る]
```

**処理内容**:
- 5日分の自動パラメータ変動（Vitality, Sanity, 科目実力など）
- ランダムイベント判定（友人イベント、アイテム獲得など）
- スキップされた日の日誌自動記録

#### Mode 2: マニュアルコントロール (Weekend & Event Day Manual Mode)
土日、および「テスト期間」「重要イベント発生日」は**ズームイン**が発生。7つの時間帯を個別に操作してリソース管理。

```
Morning (朝)
  └─ 選択肢: [登校 / 二度寝 / 遠征]
       → Vitality / Sanity 変動

AM Class (午前授業)
  └─ 選択肢: [真面目 / 内職 / サボる]
       → 理解度 / 実力 / Karma 変動

Lunch (昼食)
  └─ 選択肢: [昼食 / 昼寝 / 交流]
       → Vitality回復 / 好感度変動

PM Class (午後授業)
  └─ 選択肢: [真面目 / 内職 / サボる]
       → 理解度 / 実力 / Karma 変動

After School (放課後)
  └─ 選択肢: [部活 / アルバイト / キャラクターイベント回収]
       → スキル上昇 / Money変動 / 好感度変動

Night (夜)
  └─ 選択肢: [勉強 / 趣味 / 闇工作]
       → 科目実力 / Motivation / Karma 変動

Sleep (就寝)
  └─ 選択肢: [通常睡眠 / 徹夜 / 爆睡]
       → Sanity / Burn Out Level 変動

```

---

## 2. Player Actions: 可能なコマンド

### A. 学習系アクション

| アクション | 効果 | コスト | 解放条件 |
|:---|:---|:---|:---|
| **授業聴講** | 理解度+5〜15 | Vitality-5 | 常時 |
| **自習** | 実力+10〜20 | Vitality-10, Time-1段階 | 常時 |
| **図書館** | 知識+5, Logic+1 | Vitality-8, Time-1段階 | 常時 |
| **追試対策** | 特定科目実力+20 | Vitality-15, Time-3段階 | 赤点発生後 |
| **論文読破** | 理解度+30 (選択科目) | Vitality-15, Time-3段階 | Logic Lv.20以上 |

### B. 活動系アクション

| アクション | 効果 | コスト | 解放条件 |
|:---|:---|:---|:---|
| **部活動** | スキル+5〜10, 好感度+2 | Vitality-10, Time-1段階 | 部活加入 |
| **委員会** | Charisma+1, ランダムイベント | Vitality-8, Time-1段階 | 委員会加入 |
| **アルバイト** | Money+2000〜5000 | Vitality-12, Time-2段階 | Year 2以降 |
| **イベント回収** | キャラ好感度+5, 高頻度でアイテム獲得 | Vitality-5, Time-1段階 | 発生時のみ |
| **ボランティア** | Karma-5, 実績値+10 | Vitality-10, Time-2段階 | Year 3以降 |

### C. 社交系アクション

| アクション | 効果 | コスト | 解放条件 |
|:---|:---|:---|:---|
| **キャラクター交流** | 指定キャラ好感度+3, ランダムイベント | Vitality-3, Time-1段階 | 好感度>10 |
| **食事共有** | 複数キャラ好感度+2, Sanity+10 | Vitality-8, Money-500, Time-1段階 | 学食/カフェ解放 |
| **恋愛イベント** | ヒロイン好感度+5, ルートポイント+10 | Vitality-5, Time-2段階 | 親密度>20 |

### D. 闇系アクション (Route C)

| アクション | 効果 | コスト | 解放条件 |
|:---|:---|:---|:---|
| **ハッキング** | Money+10000, 情報獲得, Karma+10 | Vitality-8, Sanity-15, Time-2段階 | Karma>20 |
| **取引** | 特定アイテム獲得, Karma+5 | Vitality-5, Money 変動, Time-1段階 | タケシ/諏訪野好感度>15 |
| **不正サービス提供** | Money+5000, Karma+5 | Vitality-10, Sanity-10 | 進行度による |

### E. 緊急系アクション

| アクション | 効果 | コスト | 解放条件 |
|:---|:---|:---|:---|
| **保健室へ** | Vitality+30 | Time-2段階, イベント消費 | Vitality<30 |
| **カウンセリング** | Sanity+50 | Time-2段階, Money-1000 | Sanity<20 |
| **寝坊** | Vitality+40, 授業欠席 | 出席日数-1, イベント発生 | 自由 |
| **SKIP (タイムスキップ)** | 1週間進行、ルート判定 | 時間の喪失、主要イベント回収不可 | 自由（推奨されない） |

---

## 3. State Transitions: 状態遷移と判定

### A. 時間進行時の状態判定フロー

```mermaid
[時間経過 1時間帯進行]
    ↓
[パラメータ自動変動]
    ├─ Vitality 減少 (アクション種別による)
    ├─ Sanity 減少 (ストレス蓄積)
    ├─ 科目実力/理解度 増加 (学習選択時)
    └─ Good/Bad Event 判定 (ランダム)
    ↓
[ピンチ条件チェック]
    ├─ Vitality <= 0 ? → 入院イベント (1週間スキップ)
    ├─ Sanity <= 0 ? → メンタル崩壊イベント (Sanity回復クエスト)
    └─ Karma > 80 ? → 風紀委員召喚イベント
    ↓
[日内処理完了]
```

### B. 週単位の状態判定

```
[週終了時点]
    ↓
[テスト期間判定]
    ├─ YES → テストイベント発生 (全科目実力判定)
    │   ├─ 成功 (実力+理解度 > 合格ライン)
    │   └─ 失敗 → 赤点フラグ発生
    └─ NO → 通常進行
    ↓
[ルートフラグ判定]
    ├─ Engineering Points 集計
    ├─ Academic Points 集計
    ├─ Underground Points 集計
    ├─ Management Points 集計
    └─ Drifter Points 集計
    ↓
[年度末判定 (Week 32)]
    ├─ 全フラグ < 閾値 → Route E へ自動分岐
    ├─ 複数フラグ > 閾値 → プレイヤー選択分岐
    └─ 単一フラグ MAX → ルート確定
    ↓
[年度推移]
```

### C. ルート分岐の厳密な流れ (Year 3での確定)

**Year 3 Week 32 終了時**:

```
[各ルートのポイント集計]
    ↓
[ルート別の確定条件チェック]
    ├─ Route A: Engineering > 100 & ミナ好感度 > 40
    ├─ Route B: Academic > 100 & アイ好感度 > 40 & Logic > Lv.20
    ├─ Route C: Underground > 100 & Karma > 40
    ├─ Route D: Management > 100 & Charisma > Lv.10
    └─ Route E: 上記いずれも不満たす
    ↓
[分岐イベント発生]
    ├─ Route A → ミナから勧誘イベント
    ├─ Route B → アイから研究パートナー打診
    ├─ Route C → タケシから正式な誘い
    ├─ Route D → マイから学生会副会長就任打診
    └─ Route E → 室井禅からの「特別講話」
    ↓
[プレイヤー選択] OR [自動確定]
    ↓
[Year 3 Opening: ルート固定]
```

### D. 月単位のボスイベント (Boss Event Flow)

**テスト期間 (Week 8, 16, 24, 32)**:

```
[テスト前フェーズ]
    ├─ 警告ダイアログ: 「〇日後にテストです」
    ├─ 特別アクション解放: 「追試対策」「集中講義」
    └─ マイナスイベント増加 (寝坊、病気など)
    ↓
[テスト実施フェーズ]
    ├─ 全5科目の判定
    │  └─ 実力値 vs 合格ライン (80)
    ├─ 成功 → 科目実力+20, 好感度+3 (当番講師)
    └─ 失敗 → 赤点フラグ, 追試権獲得
    ↓
[テスト後フェーズ]
    ├─ 成績掲示 (GPA計算)
    ├─ 教授面談イベント (Year 4+)
    └─ 赤点回避者の優越感イベント (Year 1-2)
```

### E. 年度推移時の状態リセット

**Year 終了 → 次Year開始時**:

```
[Year End Sequence]
    ├─ ルート分岐判定 (Year 3でのみ)
    ├─ キャラロケーション更新 (進級による配置変更)
    ├─ 科目更新 (Year 2で系選択による科目変更)
    ├─ 学生寮アップグレード (Year 3で個室へ)
    ├─ パラメータの部分リセット
    │  ├─ Vitality → 50
    │  ├─ Sanity → 70
    │  ├─ Burn Out → 0
    │  └─ 科目実力 → 70% 유지 + 新科目は初期値
    └─ 新Year Opening Cutscene
```

---

## 4. イベント判定の確率構造

### A. ランダムイベント発生率

| イベント種別 | 発生確率 | 回復時間 |
|:---|:---|:---|
| **友人イベント** | 毎週 30% | 1時間帯 |
| **アイテム発見** | 毎週 15% | 0.5時間帯 |
| **バッドイベント (病気/寝坊/紛失)** | Sanity に依存 (0-50%) | 2〜4時間帯 |
| **ボーナスイベント** | Karma, Charisma に依存 | 1時間帯 |
| **緊急呼び出し** | Year 3+ で増加 | 2時間帯 |

### B. トリガーイベント (特定条件で発生)

| トリガー | 発生条件 | 効果 |
|:---|:---|:---|
| **赤点追試** | テスト失敗 | 追試権, 実力+ (成功時) |
| **恋愛進展** | 好感度 30/50/70 | ルートポイント+ , CG解放 |
| **ルート勧誘** | Year 3 Week 32 & フラグ満たす | ルート確定 |
| **入院** | Vitality ≤ 0 | 1週間スキップ, Vitality完全回復 |
| **メンタル崩壊** | Sanity ≤ 0 | 心理カウンセリングクエスト |
| **退学警告** | Karma > 90 & 出席日数不足 | Game Over (選択支) |

---

## 5. リソース管理メカニクス

### A. リソース種別と回復源

| リソース | 上限 | 回復源 | 消費源 |
|:---|:---|:---|:---|
| **Vitality** | 100 | 睡眠, 食事, 医療 | 全アクション |
| **Sanity** | 100 | 睡眠, 交流, 趣味 | 試験勉強, 闇工作, 人間関係 |
| **Money** | 無制限 | 親からの仕送り (毎月), バイト, 取引 | アイテム, 食事, 交流 |
| **Time (時間帯)** | 7/日 | リセット (毎朝) | 各アクション |
| **Motivation** | 100 | 好感度UP, 成功体験 | 失敗, 寝坊, 孤立 |

### B. リソース不足時の罰則

```
Vitality < 30      → 効率-20%, バッドイベント高頻度
Sanity < 20        → コマンド拒否 (無気力状態)
Time < 1           → その日のアクション終了
Money < 1000       → バイト強制推奨ダイアログ
```

---

## 6. Ending Flowchart

**Year 5 Week 32 終了時**:

```
[ルート別の最終評価]
    ├─ Route A: ロボコン大会成績 + ミナ関係
    ├─ Route B: 卒研評価 + アイ関係
    ├─ Route C: Money総額 + Karma評価
    ├─ Route D: 学生会実績 + マイ関係
    └─ Route E: Motivation最終値
    ↓
[True / Normal / Bad の振り分け]
    ├─ True: 最高条件達成 (CG +エピローグ)
    ├─ Normal: 中程度条件達成 (スタンダードED)
    └─ Bad: 条件不達成 (バッドED)
    ↓
[エンディング個別ムービー再生]
    ├─ ルート固有ムービー (1分30秒程度)
    ├─ キャラ別エンディング (30秒)
    └─ スタッフロール
    ↓
[NEW GAME+ アンロック]
```

---

## 補足: デバッグ用コマンド

開発/テスト用に以下のコマンドを用意。

| コマンド | 効果 |
|:---|:---|
| **skip_week** | 1週間スキップ (状態判定は実行) |
| **set_param X Y** | パラメータを直接設定 (例: set_param Logic 30) |
| **trigger_event X** | 指定イベント発生 (例: trigger_event test_exam) |
| **change_route X** | ルート強制変更 (Year 3以降のみ) |
